#' Visualize Total Costs for Pooling Design as a Function of Pool Size
#'
#' Useful for determining whether pooling is a good idea, what pool size
#' minimizes costs, and how many assays are needed for a target power.
#'
#'
#' @param g Numeric vector of pool sizes to include.
#' @param var Numeric value specifying variance of observations.
#' @param var_pe Numeric value specifying variance of additive processing error.
#' @param var_me Numeric value specifying variance of additive measurement
#' error.
#' @param type Character string specifying type of t-test. Choices are
#' \code{"two.sample"}, \code{"one.sample"}, and \code{"paired"}.
#' @param assay_cost Numeric value specifying cost of each assay.
#' @param other_costs Numeric value specifying other per-subject costs.
#' @param labels Logical value.
#' @param ... Arguments to pass to \code{\link[stats]{power.t.test}}.
#'
#'
#' @return Plot of total costs vs. pool size generated by
#' \code{\link[ggplot2]{ggplot}}.
#'
#'
#' @examples
#' # Plot study costs vs. pool size with default settings
#' poolcost_t()
#'
#' # Add processing error and other per-subject costs
#' poolcost_t(var_pe = 0.2, other_costs = 0.1)
#'
#'
#'@export
poolcost_t <- function(g = 1: 10,
                       d = 0.2,
                       var = 1,
                       var_pe = 0,
                       var_me = 0,
                       alpha = 0.05,
                       beta = 0.2,
                       type = "two.sample",
                       assay_cost = 100,
                       other_costs = 0,
                       labels = TRUE,
                       ylim = NULL,
                       ...) {

  # Prepare data for ggplot
  z <- qnorm(p = 1 - beta) + qnorm(p = 1 - alpha)
  n <- ceiling(z^2 / d^2 * (var / g + var_pe * ifelse(g > 1, 1, 0) + var_me))
  costs <-  n * (assay_cost + g * other_costs)
  df <- data.frame(g = g, n = n, costs = costs)
  df$lab <- 0
  df$labeltext <- paste(n, " assays", sep = "")
  locs <- unique(c(1, which.min(df$costs)))
  df$labeltext[-locs] <- ""
  df$lab[locs] <- 1

  # If ylim NULL, create one
  if (is.null(ylim)) {
    ylim <- c(0, max(costs) * 1.06)
  }

  # Create plot
  p <- ggplot(df, aes(g, costs, label = labeltext)) +
    geom_col() +
    labs(title = "Total Study Costs vs. Pool Size",
         y = "Total costs ($)",
         x = "Pool size") +
    ylim(ylim) +
    scale_x_continuous(breaks = g) +
    theme_bw()

  # Label min
  if (labels) {
   # p <- p + geom_label(nudge_y = max(costs) / 25)
    p <- p + geom_label_repel(point.padding = 0.3,
                              box.padding = 0.5,
                              direction = "y",
                              nudge_y = max(costs) / 25,
                              label.padding = 0.4)
  }
  p

}

# poolcost_t <- function(g = 1: 10,
#                        d = 0.2,
#                        var = 1,
#                        var_pe = 0,
#                        var_me = 0,
#                        alpha = 0.05,
#                        beta = 0.2,
#                        type = "two.sample",
#                        assay_cost = 100,
#                        other_costs = 0,
#                        labels = TRUE,
#                        ylim = NULL,
#                        ...) {
#
#   # Prepare data for ggplot
#   z <- qnorm(p = 1 - beta) + qnorm(p = 1 - alpha)
#   n <- ceiling(z^2 / d^2 * (var / g + var_pe * ifelse(g > 1, 1, 0) + var_me))
#   costs <-  n * (assay_cost + g * other_costs)
#   df <- data.frame(g = g, n = n, costs = costs)
#   df$lab <- 0
#   df$labeltext <- paste(n, " assays, $", costs, sep = "")
#   locs <- unique(c(1, which.min(df$costs)))
#   df$labeltext[-locs] <- ""
#   df$lab[locs] <- 1
#
#   df$lab <- 0
#   df$lab[which.min(df$costs)] <- 1
#   df$lab[1] <- 1
#
#   # If ylim NULL, create one
#   if (is.null(ylim)) {
#     ylim <- c(0, max(costs) * 1.05)
#   }
#
#   # Create plot
#   p <- ggplot(df, aes(g, costs, label = labeltext)) +
#     geom_point() +
#     labs(title = "Total Study Costs vs. Pool Size",
#          y = "Total costs",
#          x = "Pool size") +
#     ylim(ylim) +
#     scale_x_continuous(breaks = g) +
#     theme_bw()
#
#   # Label min
#   if (labels) {
#     p <- p + geom_label_repel(point.padding = 0.3, box.padding = 0.5)
#   }
#   p
#
# }
